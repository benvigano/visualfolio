{% extends "main/base.html" %}
{% block title %}
Overview
{% endblock title %}
{% block content %}
{% load humanize %}
{% load static %}
<h1 class="font-display font-medium text-2xl text-(--first-text-color) mt-4 mb-6">Overview</h1>
<div class="flex flex-col space-y-6">
    <div class="flex justify-between items-end">
        <h2 class="hidden lg:block font-medium text-(--first-text-color) -mb-1 mr-6">Streamgraph</h2>
        <div class="flex space-x-6">
            <div class="flex space-x-4 items-end bg-(--second-bg-color) border border-(--border-color) rounded-xl py-3 px-5">
                <div class="text-xs text-end font-medium text-(--third-text-color) mb-1">Liquid assets value:</div>
                <div class="text-(--first-text-color) text-end text-xl tabular-nums font-normal whitespace-nowrap">
                    {{ liquid_asset_value|floatformat:"2"|intcomma }} {{ base_currency }}
                </div>
            </div>
            <div class="flex space-x-4 items-end bg-(--second-bg-color) border border-(--border-color) rounded-xl py-3 px-5">
                <div class="text-xs text-end font-medium text-(--third-text-color) mb-1">Total asset value:</div>
                <div class="text-(--first-text-color) text-end text-xl tabular-nums font-normal whitespace-nowrap">
                    {{ total_asset_value|floatformat:"2"|intcomma }} {{ base_currency }}
                </div>
            </div>
        </div>
    </div>
    <div class="h-[500px] bg-(--second-bg-color) border border-(--border-color) rounded-xl">{{ graph|safe }}</div>
</div>
<div id="triggerIcon"
     class="fixed bottom-3 right-3 bg-(--first-accent-color) hover:bg-(--second-accent-color) p-1 rounded-full cursor-pointer z-50 flex items-center justify-center">
    <svg class="w-8 h-8 text-white"
         aria-hidden="true"
         xmlns="http://www.w3.org/2000/svg"
         width="24"
         height="24"
         fill="none"
         viewBox="0 0 24 24">
        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9.529 9.988a2.502 2.502 0 1 1 5 .191A2.441 2.441 0 0 1 12 12.582V14m-.01 3.008H12M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
    </svg>
</div>
<div id="walkthroughPopup"
     class="opacity-0 transition-opacity duration-300 ease-in-out fixed bottom-3 right-16 flex items-end justify-end hidden">
    <div class="bg-(--second-bg-color) rounded-2xl border-2 border-(--first-accent-color) p-4 relative">
        <div id="walkthroughContent">

            <div class="flex justify-between items-center space-x-1">
                <div class="flex space-x-0.5 items-center p-1">
                    <svg class="w-6 h-6s text-(--third-text-color)"
                         aria-hidden="true"
                         xmlns="http://www.w3.org/2000/svg"
                         width="24"
                         height="24"
                         fill="none"
                         viewBox="0 0 24 24">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M9.529 9.988a2.502 2.502 0 1 1 5 .191A2.441 2.441 0 0 1 12 12.582V14m-.01 3.008H12M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                    </svg>
                    <h2 class="pl-1 text-(--third-text-color) font-medium">Streamgraph</h2>
                    <span class="ml-2 text-sm bg-(--third-bg-color) py-0.5 px-1 rounded-md font-mono font-medium text-(--third-text-color)"></span>
                </div>
                <div class="flex items-center">
                    <button id="walkthroughTopCloseButton"
                            class="h-8 w-8 flex items-center justify-center bg-(--third-bg-color) hover:bg-(--mid-bg-color) rounded-md text-(--first-text-color) cursor-pointer transition duration-200"
                            style="cursor: pointer !important;">
                        <svg class="w-3 h-3"
                             aria-hidden="true"
                             xmlns="http://www.w3.org/2000/svg"
                             fill="none"
                             viewBox="0 0 14 14">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="flex flex-col w-80 mt-4">
                <div id="walkthroughIcon"
                     class="relative h-44 w-80 mb-4 flex items-center justify-center">
                    <img src="" alt="Icon" class=/ style="filter: grayscale(1);">
                </div>
                <p class="w-full text-(--second-text-color) bg-(--third-bg-color) rounded-xl py-3 px-4 whitespace-normal">
                </p>
            </div>
            <div class="flex justify-end items-center space-x-3 mt-4">
                <button id="backButton"
                        class="h-8 w-8 flex items-center justify-center bg-(--third-bg-color) hover:bg-(--mid-bg-color) rounded-md text-(--first-text-color) cursor-pointer transition duration-200"
                        style="cursor: pointer !important;">
                    <svg class="w-5 h-5"
                         aria-hidden="true"
                         xmlns="http://www.w3.org/2000/svg"
                         fill="none"
                         viewBox="0 0 24 24">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                <button id="nextButton"
                        class="h-8 w-8 flex items-center justify-center bg-(--first-accent-color) hover:bg-(--second-accent-color) rounded-md text-white cursor-pointer"
                        style="cursor: pointer !important;">
                    <svg class="w-5 h-5"
                         aria-hidden="true"
                         xmlns="http://www.w3.org/2000/svg"
                         fill="none"
                         viewBox="0 0 24 24">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const popup = document.getElementById("walkthroughPopup");
        const content = document.getElementById("walkthroughContent");
        const iconContainer = document.getElementById("walkthroughIcon");
        const nextButton = document.getElementById("nextButton");
        const backButton = document.getElementById("backButton");
        const topCloseButton = document.getElementById("walkthroughTopCloseButton");

        let currentPage = 0;
        const darkThemeIcons = [
            "{% static 'main/img/dark_walkthrough_1.svg' %}",
            "{% static 'main/img/dark_walkthrough_2.svg' %}",
            "{% static 'main/img/dark_walkthrough_3.svg' %}"
        ];
        const lightThemeIcons = [
            "{% static 'main/img/light_walkthrough_1.svg' %}",
            "{% static 'main/img/light_walkthrough_2.svg' %}",
            "{% static 'main/img/light_walkthrough_3.svg' %}"
        ];
        const pages = [
        { text: "The <span class='font-bold'>Streamgraph</span> shows total asset value in time, while visually separating <span class='font-bold'>earnings and expenses</span> from <span class='font-bold'>investment profit or loss</span>."},
        { text: "The <span class='font-bold'>top boundary</span> reflects<br> <span class='font-bold'>transactions</span>." },
        { text: "The <span class='font-bold'>bottom boundary</span> reflects<br><span class='font-bold'>investment profit or loss</span>." },
        { text: "The <span class='font-bold'>thickness</span> of the stream<br>reflects <span class='font-bold'>total asset value</span>." },
        ];

        const isDarkTheme = () => {
            return document.documentElement.classList.contains('dark');
        };

        const getThemeIcons = () => {
            return isDarkTheme() ? darkThemeIcons : lightThemeIcons;
        };

        const showPopup = () => {
            popup.classList.remove("hidden");
        };

        const hidePopup = () => {
            popup.classList.add("hidden");
        };

        const triggerIcon = document.getElementById("triggerIcon");
        triggerIcon.addEventListener("click", () => {
            if (popup.classList.contains("hidden")) {
                currentPage = 0;
                showPopup();
                updateContent();
            } else {
                hidePopup();
            }
        });

        const updateContent = () => {
            const page = pages[currentPage];
            const themeIcons = getThemeIcons();
        
            if (currentPage === 0) {
                iconContainer.style.display = "none";
            } else {
                iconContainer.style.display = "flex";
                const imgElement = iconContainer.querySelector("img");
                imgElement.src = themeIcons[currentPage - 1];
                imgElement.alt = `Icon ${currentPage - 1}`;
            }
        
            content.querySelector("p").innerHTML = page.text;
            content.querySelector("span").innerHTML = `[${currentPage + 1}/4]`;
        
            // Back button state
            if (currentPage === 0) {
                backButton.classList.add("opacity-50", "cursor-not-allowed", "pointer-events-none");
                backButton.disabled = true;
            } else {
                backButton.classList.remove("opacity-50", "cursor-not-allowed", "pointer-events-none");
                backButton.disabled = false;
            }
        
            // Next button state
            if (currentPage === pages.length - 1) {
                nextButton.classList.add("opacity-50", "cursor-not-allowed", "pointer-events-none");
                nextButton.disabled = true;
            } else {
                nextButton.classList.remove("opacity-50", "cursor-not-allowed", "pointer-events-none");
                nextButton.disabled = false;
            }
        };

        nextButton.addEventListener("click", () => {
            if (currentPage < pages.length - 1) {
                currentPage++;
                updateContent();
            }
        });

        backButton.addEventListener("click", () => {
            if (currentPage > 0) {
                currentPage--;
                updateContent();
            }
        });

        topCloseButton.addEventListener("click", () => {
            hidePopup();
            sessionStorage.setItem("walkthroughSeen", "true");
        });

        if (!sessionStorage.getItem("walkthroughSeen")) {
            showPopup();
            updateContent();
        }
    });
</script>
{% endblock content %}
